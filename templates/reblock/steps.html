{% extends 'reblock/review.html' %}
{% load static %}

{% block css %}
        <link rel="stylesheet" href="{% get_static_prefix %}css/home.css" type="text/css"/>
        <link rel="stylesheet" href="{% get_static_prefix %}css/layers.css" type="text/css"/>
          <link rel="stylesheet" href="/resources/demos/style.css">
  <link rel="stylesheet" href="//code.jquery.com/ui/1.11.4/themes/smoothness/jquery-ui.css">

{% endblock %}

{% block subtitle %}
    Build Site Configurations
{% endblock %}

{% block layernavs %}
<!--            <li><a href="/reblock"><div class="sitenav">Browse Data</div></a></li>-->
{% endblock %}

{% block content %}


  <head>
	
	<meta charset="utf-8" />

	<meta name="viewport" content="width=device-width, initial-scale=1.0">

	<link rel="stylesheet" href="http://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.3/leaflet.css" />
</head>


<body>
        <div id = "update">
<div id="preload" style="height:500px;width:500px;border:1px solid black;background-color:grey;"> Map is loading...</div>
</div>

	<script src="http://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.3/leaflet.js"></script>
<script type="text/javascript" src="http://code.jquery.com/jquery-1.7.1.min.js"></script>
  <script src="//code.jquery.com/ui/1.11.4/jquery-ui.js"></script>






                  <form id="layerconfigure" action="/reblock/compute/" method="POST" enctype="multipart/form-data">
                {% csrf_token %}
                {{ formset.management_form }}
    <input type="submit" value="Check" />
    <div> Project Index: <input type="text" name="projindex"/>(default = 0)</div>
    <div> Intermediate Step Index: <input type="text" name="stepindex"/></div>
        

<div id = "update3">
    
</div>


<div id = 'bt1'>
</div>
<div id = 'bt2'>
</div>
<div id = 'bt3'>
</div>


              </form>
              
{% endblock %}

{% block scripts %}
<script>


var loadmap = function(ori,road, inter){

var oriJSONList = ((ori).replace(/&(l|g|quo)t;/g, function(a,b){
                return {
                    l   : '<',
                    g   : '>',
                    quo : '"'
                }[b];
            }));

var oriData = JSON.parse( oriJSONList );

var roadJSONList = ((road).replace(/&(l|g|quo)t;/g, function(a,b){
                return {
                    l   : '<',
                    g   : '>',
                    quo : '"'
                }[b];
            }));

var roadData = JSON.parse( roadJSONList );


var interJSONList = ((inter).replace(/&(l|g|quo)t;/g, function(a,b){
                return {
                    l   : '<',
                    g   : '>',
                    quo : '"'
                }[b];
            }));

var interData = JSON.parse( interJSONList );



var orilayer = L.geoJson(oriData, {
            weight: 1.5,
            color: "#FFA500",
            opacity: 0.8,
            fillColor: "#B0DE5C",
            fillOpacity: 0.8,
            dashArray: '4',

		});

var interlayer = L.geoJson(interData, {
            weight: 2.5,
            color: "#FFA500",
            opacity: 0.8,
            fillColor: "#blue",
            fillOpacity: 0.8

		});

var roadlayer = L.geoJson(roadData, {
            weight: 2.5,
            color: "#2F4F4F",
            opacity: 0.8,
            fillColor: "#B0DE5C",
            fillOpacity: 0.8

		});
        
marker.push(orilayer);
marker.push(interlayer);
marker.push(roadlayer);


for(var i=0;i<marker.length;i++) {
    map.addLayer(marker[i]);
    }  


map.fitBounds(marker[0].getBounds());
}


var run = 1;
var marker = new Array();
var test = 5;

var map = null;
var setup = 1;
var inter = 3000;
var refreshID = null;
var slider_A = '<form id="reservation"><label for="minbeds">Step Selected</label><select name="minbeds" id="minbeds">'
var slider_B = '</select></form>'

var refreshID = setInterval(function(){update();},inter);
console.log("test");

var steps = null;


var update = function(){
        reloadstep();
        console.log("second");
}




function reloadall(){
    $.getJSON("/reblock/reload/", {pr_id: "{{project_id}}"}, function(json){
for(var i=0;i<marker.length;i++) {
    map.removeLayer(marker[i]);
    }
    marker = new Array();
    loadmap(json["ori"],json["rd"], json["int"]);
<<<<<<< HEAD
    steps = json["stepnumber"]+1;
    
=======
  
    steps = json["stepnumber"]
>>>>>>> peng_save
    console.log(steps);
    
var innerdata = "text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(json["int"]).replace(/\\/g, ''));
var oridata = "text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(json["ori"]).replace(/\\/g, ''));
var rddata = "text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(json["rd"]).replace(/\\/g, ''));
<<<<<<< HEAD

var bt1_link= '"data:' + innerdata + '" download="data.json"'
var bt1stri = '<form action='+bt1_link+' id = "removebt1"><input type="submit" value="Interial parcels"></form>'
var bt2_link= '"data:' + oridata + '" download="data.json"'
var bt2stri = '<form action='+bt2_link+' id = "removebt2"><input type="submit" value="Original parcels"></form>'
var bt3_link= '"data:' + rddata + '" download="data.json"'
var bt3stri = '<form action='+bt3_link+' id = "removebt3"><input type="submit" value="Roads"></form>'


$("#bt1").append(bt1stri);
$("#bt2").append(bt2stri);
$("#bt3").append(bt3stri);

    
    
            //function for sliders, remove previous, and update option according to steos
        $(function() {
      console.log("2222222222222333333 "+steps);
    console.log(44444444444444444444);
    $( "#minbeds" ).remove();
    var slider = slider_A;
    for (var i = 0;i<steps.valueOf();i++){
    slider += '<option>' + i + '</option>';
}
    slider += slider_B;
    console.log(slider);
    
    $("#update3").append(slider);
      
    var select = $( "#minbeds" );

    var slider = $( "<div id='slider'></div>" ).insertAfter( select ).slider({
      min: 1,
      max: steps,
      range: "min",
      value: select[ 0 ].selectedIndex + 1,
      slide: function( event, ui ) {
        select[ 0 ].selectedIndex = ui.value - 1;
        
        
        checkstep(select[ 0 ].selectedIndex);
        

      }
    });
    $( "#minbeds" ).change(function() {
      slider.slider( "value", this.selectedIndex + 1 );

    });

  });
    
    
    
    
    
=======
$('<a href="data:' + rddata + '" download="data.json">  ||Roads||  </a>').appendTo('#container');


>>>>>>> peng_save
  });
  
  
  
  
  
}

function checkstep(step_index){
    
    $.getJSON("/reblock/check_step/", {pr_id: "{{project_id}}", step: step_index}, function(json){
for(var i=0;i<marker.length;i++) {
    map.removeLayer(marker[i]);
    }
    marker = new Array();
    loadmap(json["ori"],json["rd"], json["int"]);
    steps = json["stepnumber"];
    
/////////remove previous button
$("#removebt1").remove();
$("#removebt2").remove();
$("#removebt3").remove();

var innerdata = "text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(json["int"]).replace(/\\/g, ''));
var oridata = "text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(json["ori"]).replace(/\\/g, ''));
var rddata = "text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(json["rd"]).replace(/\\/g, ''));

var bt1_link= '"data:' + innerdata + '" download="data.json"'
var bt1stri = '<form action='+bt1_link+' id = "removebt1"><input type="submit" value="Interial parcels"></form>'
var bt2_link= '"data:' + oridata + '" download="data.json"'
var bt2stri = '<form action='+bt2_link+' id = "removebt2"><input type="submit" value="Original parcels"></form>'
var bt3_link= '"data:' + rddata + '" download="data.json"'
var bt3stri = '<form action='+bt3_link+' id = "removebt3"><input type="submit" value="Roads"></form>'

$("#bt1").append(bt1stri);
$("#bt2").append(bt2stri);
$("#bt3").append(bt3stri);



  });
}


function reloadstep(){
    $.getJSON("/reblock/reload_step/", {pr_id: "{{project_id}}"}, function(json){
    if (json["start"]){
        if (json["step"]){
            
            if (setup){
            $("#preload").remove();
            $("#update").append('<div style="width:500px; height:500px" id="map"></div>')
            map = L.map('map');
            
            L.tileLayer('https://{s}.tiles.mapbox.com/v3/{id}/{z}/{x}/{y}.png', {
			maxZoom: 18,
			attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, ' +
				'<a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' +
				'Imagery Â© <a href="http://mapbox.com">Mapbox</a>',
			id: 'examples.map-20v6611k'
		}).addTo(map);
        setup = 0;
}
            
            if (json["finish"] ){
        clearInterval(refreshID);
        reloadall();
        
        console.log("33333344444 "+steps);
        

        
        
        
        
        
        
    }else{
        for(var i=0;i<marker.length;i++) {
    map.removeLayer(marker[i]);
    }   
        marker = new Array();
      loadmap(json["ori"],json["rd"], json["int"]);

}
             
        }else{
$("#preload").remove();
           $("#update").append('<div id="preload" style="height:500px;width:500px;border:1px solid black;background-color:grey;"> Making graph...</div>'); 
            
            
        }
        
        
        
        

}

  }
);
}







</script>
{% endblock %}




